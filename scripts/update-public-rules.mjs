import fs from 'node:fs/promises';
import path from 'node:path';

const OUT_PATH = path.resolve('src/data/publicRules.ts');

async function fetchText(url) {
  const res = await fetch(url, {
    headers: {
      // Some gov sites behave differently without a UA.
      'user-agent': 'RetirementResourceBot/1.0 (+https://github.com/kawabunga8/RetirementResource)'
    }
  });
  if (!res.ok) throw new Error(`Fetch failed ${res.status} for ${url}`);
  return await res.text();
}

function parseTfsaAnnualLimitsFromText(html) {
  // CRA pages often contain the annual limits as a simple list/table.
  // We'll extract year + amount pairs like "2026 $7,000".
  // This is intentionally resilient rather than strict HTML parsing.
  const matches = [...html.matchAll(/\b(20\d{2})\b[^\d]{0,20}\$\s*([0-9]{1,3}(?:,[0-9]{3})*)/g)];
  const byYear = {};
  for (const m of matches) {
    const year = m[1];
    const amount = Number(m[2].replaceAll(',', ''));
    if (!Number.isFinite(amount)) continue;

    // TFSA annual limits are in the 4k-10k range historically; use as a sanity filter.
    if (amount < 3000 || amount > 20000) continue;

    // Prefer the first occurrence for a year, but allow overwrite (last wins) if repeated.
    byYear[year] = amount;
  }

  // Keep only plausible TFSA years starting 2009
  const filtered = Object.fromEntries(
    Object.entries(byYear)
      .filter(([y]) => Number(y) >= 2009 && Number(y) <= new Date().getUTCFullYear() + 1)
      .sort((a, b) => Number(a[0]) - Number(b[0]))
  );

  return filtered;
}

function formatTsObject(obj) {
  const entries = Object.entries(obj);
  const lines = entries.map(([k, v]) => `  ${JSON.stringify(k)}: ${v},`);
  return `export const TFSA_ANNUAL_LIMIT_BY_YEAR = {\n${lines.join('\n')}\n} as const;\n`;
}

async function main() {
  // CRA TFSA contribution room calculator page reliably includes the current-year limit.
  // Example text: "The TFSA dollar limit for 2026 is $7,000."
  const CRA_TFSA_URL =
    'https://www.canada.ca/en/revenue-agency/services/tax/individuals/topics/tax-free-savings-account/contributing/calculate-room.html';

  const html = await fetchText(CRA_TFSA_URL);

  // Start from the fallback file values so we keep historical years stable.
  // We'll overwrite/add any year we can parse from CRA.
  const existing = await fs.readFile(OUT_PATH, 'utf8');
  const existingMatches = [...existing.matchAll(/\"(20\d{2})\"\s*:\s*(\d+)/g)];
  const tfsa = {};
  for (const m of existingMatches) tfsa[m[1]] = Number(m[2]);

  const parsed = parseTfsaAnnualLimitsFromText(html);
  // Also parse the explicit “TFSA dollar limit for YYYY is $X” sentence.
  for (const m of html.matchAll(/TFSA dollar limit for\s+(20\d{2})\s+is\s+\$\s*([0-9]{1,3}(?:,[0-9]{3})*)/gi)) {
    parsed[m[1]] = Number(m[2].replaceAll(',', ''));
  }

  for (const [y, v] of Object.entries(parsed)) tfsa[y] = v;

  const years = Object.keys(tfsa);
  if (years.length < 10) {
    throw new Error(`TFSA limits table too small after merge (${years.length}).`);
  }

  const content = `// AUTO-GENERATED by scripts/update-public-rules.mjs\n// Source: ${CRA_TFSA_URL}\n\nexport type TfsaLimitByYear = Record<string, number>;\n\n${formatTsObject(tfsa)}\n\nexport const FHSA_RULES = {\n  annualLimitPerPerson: 8000,\n  lifetimeCapPerPerson: 40000,\n} as const;\n`;

  await fs.writeFile(OUT_PATH, content, 'utf8');
  console.log(`Updated ${OUT_PATH} with ${Object.keys(tfsa).length} TFSA years`);
}

main().catch(async (err) => {
  console.error('update-public-rules failed:', err?.message || err);
  console.error('Keeping existing publicRules.ts (fallback table).');
  process.exitCode = 0;
});
